{"componentChunkName":"component---src-templates-blogpost-tsx","path":"/blog/hc-auth-demo","result":{"data":{"site":{"siteMetadata":{"title":"Marcin Janiak","description":"Yet another coding blog.","siteUrl":"http://marcin-janiak.github.io","author":{"name":"Marcin Janiak","url":""}}},"markdownRemark":{"html":"<p>Recently in the company, we have started to use GraphQL in business projects. Being more specific, a server-based implementation - HotChocolate.</p>\n<p>Basically most of the projects need some kind of authentication and some of the apps might also require to specify roles and permissions.</p>\n<p>The key advantage of HotChocolate is a great integration with asp.net core mechanisms and also a rich ecosystem of various solutions, e.g:</p>\n<ul>\n<li>Strawberry Shake - .NET client for GraphQL</li>\n<li>Banana Cake Pop - GraphQL IDE</li>\n<li>Green Donut - a port of facebook’s DataLoader utility</li>\n</ul>\n<p>Few words to mention: The code below is simplified and should not be used in production as it is.</p>\n<h2>Installing required NuGet packages</h2>\n<ul>\n<li>HotChocolate.AspNetCore, 11.0.0-preview.118</li>\n<li>HotChocolate.AspNetCore.Authorization, 11.0.0-preview.118</li>\n<li>HotChocolate.AspNetCore.Playground, 11.0.0-preview.118</li>\n<li>Microsoft.AspNetCore.Authentication.JwtBearer, 3.1.3</li>\n<li>Microsoft.IdentityModel.Tokens, 6.5.0</li>\n</ul>\n<p>We want to start off by creating some kind of Identity Service implementation and adding authentication (JWT based) in a ConfigureServices and Configure method in Startup.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Collections<span class=\"token punctuation\">.</span>Generic</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>IdentityModel<span class=\"token punctuation\">.</span>Tokens<span class=\"token punctuation\">.</span>Jwt</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Linq</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>Authentication</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>Claims</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Text</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Threading<span class=\"token punctuation\">.</span>Tasks</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>IdentityModel<span class=\"token punctuation\">.</span>Tokens</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">GraphQLAuthDemo</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IIdentityService</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">Authenticate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IdentityService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IIdentityService</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">Authenticate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//Your custom logic here (e.g. database query)</span>\n            <span class=\"token comment\">//Mocked for a sake of simplicity</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> roles <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hr\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hr\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dev\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dev\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leader\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leader\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"employee\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"employee\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>roles<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">GenerateAccessToken</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> Guid<span class=\"token punctuation\">.</span><span class=\"token function\">NewGuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> roles<span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AuthenticationException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GenerateAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> userId<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> roles<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> key <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SymmetricSecurityKey</span><span class=\"token punctuation\">(</span>\n                Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">.</span><span class=\"token function\">GetBytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"secretsecretsecret\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> claims <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>Claim<span class=\"token punctuation\">></span></span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Claim</span><span class=\"token punctuation\">(</span>ClaimTypes<span class=\"token punctuation\">.</span>NameIdentifier<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Claim</span><span class=\"token punctuation\">(</span>ClaimTypes<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            claims <span class=\"token operator\">=</span> claims<span class=\"token punctuation\">.</span><span class=\"token function\">Concat</span><span class=\"token punctuation\">(</span>roles<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>role <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Claim</span><span class=\"token punctuation\">(</span>ClaimTypes<span class=\"token punctuation\">.</span>Role<span class=\"token punctuation\">,</span> role<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> signingCredentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SigningCredentials</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> SecurityAlgorithms<span class=\"token punctuation\">.</span>HmacSha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JwtSecurityToken</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"issuer\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"audience\"</span><span class=\"token punctuation\">,</span>\n                claims<span class=\"token punctuation\">,</span>\n                <span class=\"token named-parameter punctuation\">expires</span><span class=\"token punctuation\">:</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span><span class=\"token function\">AddDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">90</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token named-parameter punctuation\">signingCredentials</span><span class=\"token punctuation\">:</span> signingCredentials<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JwtSecurityTokenHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WriteToken</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","excerpt":"Recently in the company, we have started to use GraphQL in business projects. Being more specific, a server-based implementation - HotChocolate. Basically most of the projects need some kind of authentication and some of the apps might also require to specify roles and permissions. The key advantage of HotChocolate is a great integration with asp.net core mechanisms and also a…","timeToRead":2,"fields":{"slug":"/blog/hc-auth-demo"},"frontmatter":{"postedAt":{"name":"Medium","url":"https://medium.com/@marcinjaniak/graphql-simple-authorization-and-authentication-with-hotchocolate-11-and-asp-net-core-3-162e0a35743d"},"title":"Simple authorization and authentication with HotChocolate 11 and ASP.NET Core 3","date":"2020-04-01","tags":["GraphQL","HotChocolate","aspnetcore"],"headerImg":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAB0ElEQVQY0yXRXW/ScBQG8H4U42cw2YI6IetcLCMCLQM2mIxRG1hf6PpCgbVQoLy2a8sQBBUDZjNgZ2J0ybzy1ksTo/sQfgBv/VeSc/vLeZ5zINFnFmHjdKtX2e6oSFMLaJ1gQw+rZqTSjynD/fIkKU0PxRnOXRDsIsdc0eQnNvdFIG4KOMQ/slZehnUV1mtISws028G6gVbtXeU8Jrv+4L/PcJdZdknSVxQF/LVAQCcPbd5rSV6bR1pMpFzd7tX9mrajqUgbpLAilUFcHiZKk2fSNMVPDvh5Ju96d38Woj3nwLMPBlwgWcTWxE2tDJuNHe2bfPhVynSCdR1V+1FllChq4e5zz6iE2DOcXx4DT0HM/T6zPlJRYR5fe++99yr/2IjysyPhzxz++3n9l4ne2uGPDNkLKc30h4Fww/ovdawK8OKYdmPnPYNuqPh7fPfH9M737oYRYwy0dmuHfp5hc5xzaPJNSgTN5UC/vLtk4fHLhOBQtAM28xtWwWeKPmuYJi7yWDNUUZ90QdteqAYCr84O5OtUAYwVV6dHkkORbueTLCR6TWnTfVUJNk+3zLq/3XraAPIMq9pR5cVeeZwsAfY2LbzDuUWOdkhqda1rnvgHhX/hdy4H7tMAAAAASUVORK5CYII=","aspectRatio":2.6666666666666665,"src":"/static/3ce181dd4ad5bd2cd431a54fec82c613/96139/auth.png","srcSet":"/static/3ce181dd4ad5bd2cd431a54fec82c613/fe034/auth.png 240w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/78efc/auth.png 480w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/96139/auth.png 960w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/09618/auth.png 1280w","sizes":"(max-width: 960px) 100vw, 960px"}}}}}},"pageContext":{"slug":"/blog/hc-auth-demo","isBlogPost":true}},"staticQueryHashes":[]}