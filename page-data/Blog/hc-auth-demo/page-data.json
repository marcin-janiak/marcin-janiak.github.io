{"componentChunkName":"component---src-templates-blogpost-tsx","path":"/blog/hc-auth-demo","result":{"data":{"site":{"siteMetadata":{"title":"Marcin Janiak","description":"Yet another coding blog.","author":{"name":"Marcin Janiak","url":""}}},"markdownRemark":{"html":"<p>Recently in the company, we have started to use GraphQL in business projects. Being more specific, a server-based implementation - HotChocolate.</p>\n<p>Basically most of the projects need some kind of authentication and some of the apps might also require to specify roles and permissions.</p>\n<p>The key advantage of HotChocolate is a great integration with asp.net core mechanisms and also a rich ecosystem of various solutions, e.g:</p>\n<ul>\n<li>Strawberry Shake - .NET client for GraphQL</li>\n<li>Banana Cake Pop - GraphQL IDE</li>\n<li>Green Donut - a port of facebook’s DataLoader utility</li>\n</ul>\n<p>Few words to mention: The code below is simplified and should not be used in production as it is.</p>\n<h2>Installing required NuGet packages</h2>\n<ul>\n<li>HotChocolate.AspNetCore, 11.0.0-preview.118</li>\n<li>HotChocolate.AspNetCore.Authorization, 11.0.0-preview.118</li>\n<li>HotChocolate.AspNetCore.Playground, 11.0.0-preview.118</li>\n<li>Microsoft.AspNetCore.Authentication.JwtBearer, 3.1.3</li>\n<li>Microsoft.IdentityModel.Tokens, 6.5.0</li>\n</ul>\n<p>We want to start off by creating some kind of Identity Service implementation and adding authentication (JWT based) in a ConfigureServices and Configure method in Startup.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-csharp line-numbers\"><code class=\"language-csharp\"><span class=\"token keyword\">using</span> <span class=\"token namespace\">System</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Collections<span class=\"token punctuation\">.</span>Generic</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>IdentityModel<span class=\"token punctuation\">.</span>Tokens<span class=\"token punctuation\">.</span>Jwt</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Linq</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>Authentication</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Security<span class=\"token punctuation\">.</span>Claims</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Text</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">System<span class=\"token punctuation\">.</span>Threading<span class=\"token punctuation\">.</span>Tasks</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">using</span> <span class=\"token namespace\">Microsoft<span class=\"token punctuation\">.</span>IdentityModel<span class=\"token punctuation\">.</span>Tokens</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">namespace</span> <span class=\"token namespace\">GraphQLAuthDemo</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">interface</span> <span class=\"token class-name\">IIdentityService</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">Authenticate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">IdentityService</span> <span class=\"token punctuation\">:</span> <span class=\"token type-list\"><span class=\"token class-name\">IIdentityService</span></span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">public</span> <span class=\"token keyword\">async</span> <span class=\"token return-type class-name\">Task<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span> <span class=\"token function\">Authenticate</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> password<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">//Your custom logic here (e.g. database query)</span>\n            <span class=\"token comment\">//Mocked for a sake of simplicity</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> roles <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hr\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"hr\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dev\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"dev\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leader\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"leader\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">.</span><span class=\"token function\">Contains</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"employee\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                roles<span class=\"token punctuation\">.</span><span class=\"token function\">Add</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"employee\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>roles<span class=\"token punctuation\">.</span>Count <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token function\">GenerateAccessToken</span><span class=\"token punctuation\">(</span>email<span class=\"token punctuation\">,</span> Guid<span class=\"token punctuation\">.</span><span class=\"token function\">NewGuid</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> roles<span class=\"token punctuation\">.</span><span class=\"token function\">ToArray</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">AuthenticationException</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">private</span> <span class=\"token return-type class-name\"><span class=\"token keyword\">string</span></span> <span class=\"token function\">GenerateAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token class-name\"><span class=\"token keyword\">string</span></span> email<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span></span> userId<span class=\"token punctuation\">,</span> <span class=\"token class-name\"><span class=\"token keyword\">string</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span></span> roles<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">{</span>\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> key <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SymmetricSecurityKey</span><span class=\"token punctuation\">(</span>\n                Encoding<span class=\"token punctuation\">.</span>UTF8<span class=\"token punctuation\">.</span><span class=\"token function\">GetBytes</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"secretsecretsecret\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> claims <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">List<span class=\"token punctuation\">&lt;</span>Claim<span class=\"token punctuation\">></span></span>\n            <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Claim</span><span class=\"token punctuation\">(</span>ClaimTypes<span class=\"token punctuation\">.</span>NameIdentifier<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Claim</span><span class=\"token punctuation\">(</span>ClaimTypes<span class=\"token punctuation\">.</span>Name<span class=\"token punctuation\">,</span> email<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n            claims <span class=\"token operator\">=</span> claims<span class=\"token punctuation\">.</span><span class=\"token function\">Concat</span><span class=\"token punctuation\">(</span>roles<span class=\"token punctuation\">.</span><span class=\"token function\">Select</span><span class=\"token punctuation\">(</span>role <span class=\"token operator\">=></span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">Claim</span><span class=\"token punctuation\">(</span>ClaimTypes<span class=\"token punctuation\">.</span>Role<span class=\"token punctuation\">,</span> role<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">ToList</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> signingCredentials <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">SigningCredentials</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> SecurityAlgorithms<span class=\"token punctuation\">.</span>HmacSha256<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token class-name\"><span class=\"token keyword\">var</span></span> token <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JwtSecurityToken</span><span class=\"token punctuation\">(</span>\n                <span class=\"token string\">\"issuer\"</span><span class=\"token punctuation\">,</span>\n                <span class=\"token string\">\"audience\"</span><span class=\"token punctuation\">,</span>\n                claims<span class=\"token punctuation\">,</span>\n                <span class=\"token named-parameter punctuation\">expires</span><span class=\"token punctuation\">:</span> DateTime<span class=\"token punctuation\">.</span>Now<span class=\"token punctuation\">.</span><span class=\"token function\">AddDays</span><span class=\"token punctuation\">(</span><span class=\"token number\">90</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n                <span class=\"token named-parameter punctuation\">signingCredentials</span><span class=\"token punctuation\">:</span> signingCredentials<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n            <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token constructor-invocation class-name\">JwtSecurityTokenHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">WriteToken</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>","excerpt":"Recently in the company, we have started to use GraphQL in business projects. Being more specific, a server-based implementation - HotChocolate. Basically most of the projects need some kind of authentication and some of the apps might also require to specify roles and permissions. The key advantage of HotChocolate is a great integration with asp.net core mechanisms and also a…","timeToRead":2,"frontmatter":{"title":"Simple authorization and authentication with HotChocolate 11 and ASP.NET Core 3","date":"2020-04-01","tags":["GraphQL","HotChocolate","aspnetcore"],"headerImg":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAIAAADwazoUAAAACXBIWXMAAAsTAAALEwEAmpwYAAACT0lEQVQozzXS3U7aYBgH8F7KsmtYomGbw1BHLHazfChsoIggIrQFaWtLoVCgfJSPUmR+j0UWNTA02aaJJlvc4Q6XLJsXsQvY6Z6CS97TX/7P8/4fhJvWBLSRnqllrVUZKym4Up0v1u2y5sq23dLOa/HAx3dXuONQ8iSc6G/Q51TsY2Ljkg1fb4UQ5llr7DNoXUbreays4KXKfKHhyOkL0rY7Y/ilkQ8mTyOJQYw6J0nwV2wY2XyqM+YWb9YZrEy7xJy1VrApypwiYxWYouXKdjyZHW/qYJnv+pmDJaYXjBveyI8glGkbfOJJJ4n7BOcEZ1FEVCvOKbeZlRs+WJ0v1B1ye1Ha9QqKXV0z7aYw/TjEDKLgSYR+3KYnd2UH2/NMnJkfHcafNxaZ41X2Tw/9+3nyl+a40+0XdKxGSKXAhw57nbCd1p05wP0oZYwdN3VUQvi9//BH98F3darhphuO/J1O/Gw6e6HkkIq99XOweQZviwuDBLq/52WHJDWEZGaqtTWtcdOtnUD4JO4sEVl5VoVta0QeBh5/O8gj/xa8lkfurvJDMmbsvBlBOLPGW4yqUqiWntEKtkr5ZRFk05nTF6U3r8R9XwrYuwD7PpTsb1DDGDn+rSsmjAiWZhqtSVYVSirhRZAqUWiMpSe95xWOlu/l6Xp8EKVhf8iEnm74EJKeUeE88liliCsVyLTnm3Aeo8w9n3Dk5wy5tnkWAUld0NFP9zL4VQwgkCnPVoq2cvnF/8wF6DYN3RxCtwGuN8rsR8e3Fblk1uG2vqQC3yT/PylNN/43UzDAAAAAAElFTkSuQmCC","aspectRatio":1.7699115044247788,"src":"/static/3ce181dd4ad5bd2cd431a54fec82c613/ee604/auth.png","srcSet":"/static/3ce181dd4ad5bd2cd431a54fec82c613/69585/auth.png 200w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/497c6/auth.png 400w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/ee604/auth.png 800w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/f3583/auth.png 1200w,\n/static/3ce181dd4ad5bd2cd431a54fec82c613/e4d72/auth.png 1280w","sizes":"(max-width: 800px) 100vw, 800px"}}}}}},"pageContext":{"slug":"/blog/hc-auth-demo","isBlogPost":true}}}